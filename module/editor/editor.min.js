function afoxEditor(e,t){this.html=t.html,this.required=t.required,this.readonly=t.readonly,this.isHtmlmode=!1;const n=document.querySelector("#"+e),o=document.createElement("iframe"),i=n.querySelector("[name="+t.name+"]"),s=n.querySelectorAll("#editorTypebar [data-target]"),a=n.querySelectorAll("#editorToolbar button"),r=n.querySelectorAll('[name="upload_files[]"]'),l=n.querySelector("#uploadFiles"),d=n.querySelectorAll("#uploadedFiles img"),c=e=>{this.isHtmlmode=i.classList.contains("d-none"),e&&!this.isHtmlmode?(o.style.height=i.offsetHeight+"px",o.contentWindow.document.body.innerHTML=i.value,i.classList.add("d-none"),o.classList.remove("d-none"),this.required&&i.removeAttribute("required")):!e&&this.isHtmlmode&&(i.style.height=o.offsetHeight+"px",i.value=o.contentWindow.document.body.innerHTML,o.classList.add("d-none"),i.classList.remove("d-none"),this.required&&i.setAttribute("required","")),this.isHtmlmode=i.classList.contains("d-none")};this.querySelector=e=>(this.isHtmlmode||(o.contentWindow.document.body.innerHTML=i.value),o.contentWindow.document.body.querySelector(e)),this.querySelectorAll=e=>(this.isHtmlmode||(o.contentWindow.document.body.innerHTML=i.value),o.contentWindow.document.body.querySelectorAll(e)),this.getSelection=()=>{const e=o.contentWindow;return this.isHtmlmode?e.document.body.focus():i.focus(),this.isHtmlmode?e.getSelection?e.getSelection():e.document.getSelection?e.document.getSelection():void 0:{start:i.selectionStart,end:i.selectionEnd,value:i.value.slice(i.selectionStart,i.selectionEnd)}},this.pasteHtml=e=>{const t=this.getSelection();if(this.isHtmlmode){let n=t.getRangeAt(0);if(n){const i=o.contentWindow.document.createElement("div");i.appendChild(n.cloneContents()),i.innerHTML=e.replace(/%s/,i.innerHTML?i.innerHTML:"..."),n.deleteContents(),n.insertNode(i.firstElementChild),n.setStart(t.focusNode,t.focusOffset),n.setEnd(t.anchorNode,t.anchorOffset)}}else{e=e.replace(/%s/,t.value?t.value:"...");const n=i.value.slice(0,t.start),o=i.value.slice(-1*(i.value.length-t.end));i.value=n+e+o}},o.classList.add("form-control","resizable","p-0","d-none"),o.addEventListener("load",(e=>{const t=`<meta http-equiv="Pragma" content="no-cache">\n\t\t<meta http-equiv="Cache-Control" content="no-cache">\n\t\t<link rel="stylesheet" href="${request_uri}module/editor/editor.min.css">`;o.style.resize="vertical",o.contentWindow.document.head.innerHTML=t,o.contentWindow.document.designMode=this.readonly?"off":"on",o.contentWindow.document.body.innerHTML=i.value,o.contentWindow.document.body.addEventListener("drop",(e=>{e.preventDefault(),this.pasteHtml(e.dataTransfer.getData("text")||"")}))})),i.parentNode.insertBefore(o,i),this.readonly&&(i.readOnly=!0);const u=e=>{const t=e.target.getAttribute("src").getQuery("file"),o=n.querySelector('[name="remove_files[]"][value="'+t+'"]');if(o)o.remove();else{const n=document.createElement("input");n.setAttribute("type","hidden"),n.setAttribute("name","remove_files[]"),n.setAttribute("value",t),e.target.parentNode.insertBefore(n,e.target)}},m=e=>{const t=e.target.getAttribute("src").getQuery("file");if(n.querySelector('[name="remove_files[]"][value="'+t+'"]'))return e.preventDefault(),e.stopPropagation(),!1;if(/<[img][^>]+[class]=[\\"\']+image\//g.test(e.target.outerHTML))e.dataTransfer.setData("text",e.target.outerHTML);else{const t=e.target.outerHTML.replace(/^(<[img]+\ssrc)([^>]+title=[\\"\']+)([^>\\"\']+)([^>]+)srcset=[\\"\']+[^>\\"\']+([^>]+>)$/g,'<a href$2$3$4target="_file$5$3</a>');e.dataTransfer.setData("text",t)}};d.forEach((e=>{e.addEventListener("click",u),e.addEventListener("dragstart",m)}));const h=e=>{for(window.dispatchEvent(new Event("beforeunload",{bubbles:!0,cancelable:!1}));l.firstChild;)l.removeChild(l.lastChild);const t=window.URL||window.webkitURL;Object.keys(e.target.files).map((n=>{let o=document.createElement("span"),i=e.target.files[n].name.escapeHtml(),s=e.target.files[n].size.shortSize(),a=e.target.files[n].type.escapeHtml(),r=t.createObjectURL(e.target.files[n]);window.uploadFiles.push(r);const d=window.uploadFiles.length-1;"image"!=a.slice(0,5)&&(a+='" srcset="./module/editor/bi-binary.svg');let c=`="${r}" title="${i} (${s})" alt="${i}" target="${d}"`;o.innerHTML='<image class="'+a+'" src'+c+">"+(1===e.target.files.length?"<span>"+e.target.value+"</span>":""),c="image"==a.slice(0,5)?"<image src"+c+">":`<a href${c}>${i} (${s})</a>`,o.addEventListener("dragstart",(e=>{e.dataTransfer.setData("text",c)})),l.append(o)}))};r.forEach((e=>e.addEventListener("change",h)));const g=e=>{e.preventDefault(),e.stopPropagation();const t={bold:"**%s**",italic:"*%s*",underline:"<u>%s</u>",strikethrough:"~~%s~~",insertorderedlist:"\n1. %s\n2. ",header:"<h2>%s</h2>",indent:"<blockquote>%s</blockquote>",codeblock:"<pre><code>%s</code></pre>",highlight:"<code>%s</code>"};let n=e.target.closest("button");switch(n=n.getAttribute("aria-label").toLowerCase(),n){case"bold":case"italic":case"underline":case"strikethrough":case"insertorderedlist":this.isHtmlmode?o.contentWindow.document.execCommand(n,!1,null):this.pasteHtml(t[n]);break;case"highlight":this.pasteHtml(this.isHtmlmode?t[n]:"`%s`");break;case"components":break;default:this.pasteHtml(t[n]);break}this.isHtmlmode?o.contentWindow.document.body.focus():i.focus()},f=e=>{e.preventDefault(),e.stopPropagation();const t=e.target.getAttribute("data-target"),a=n.querySelector("[name="+t+"]"),r=e.target.getAttribute("data-value");"true"==r?(a.value=a.value==r?"false":"true","true"==a.value?e.target.classList.add("checked"):e.target.classList.remove("checked")):(s.forEach((e=>{"true"!=e.getAttribute("data-value")&&e.classList.remove("checked")})),a.value=r,e.target.classList.add("checked"),c("HTML"===e.target.innerText)),this.isHtmlmode?o.contentWindow.document.body.focus():i.focus()};a.forEach((e=>e.addEventListener("click",g))),s.forEach((e=>e.addEventListener("click",f))),s.forEach((e=>e.addEventListener("keydown",(e=>{32==e.which&&!0!==e.shiftKey&&(e.preventDefault(),e.stopPropagation(),e.target.click())}))));const v=n.closest("FORM");v.hasAttribute("needvalidate")&&v.setAttribute("novalidate",""),v.addEventListener("submit",(e=>{try{if(this.isHtmlmode&&(i.value=o.contentWindow.document.body.innerHTML),content_validity=!this.required||i.value,e.currentTarget.hasAttribute("needvalidate"))content_validity&&e.currentTarget.checkValidity()||(e.preventDefault(),e.stopPropagation()),content_validity||o.contentWindow.document.body.classList.add("is-invalid"),e.currentTarget.classList.add("was-validated");else if(!content_validity)throw this.isHtmlmode?o.contentWindow.document.body.focus():i.focus(),new Error(this.required)}catch(t){e.preventDefault(),e.stopPropagation(),alert(t)}}),!1),this.html&&c(!0)}!function(){"use strict";window.uploadFiles=[],window.addEventListener("beforeunload",(e=>{let t;const n=window.URL||window.webkitURL;for(;window.uploadFiles.length>0;)t=window.uploadFiles.pop(),n.revokeObjectURL(t)}))}();