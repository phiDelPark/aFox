function afEditor(e,t){this.html=t.html,this.required=t.required,this.readonly=t.readonly,this.isHtmlmode=!1;const n=document.querySelector("#"+e),o=n.querySelector("[name="+t.name+"]"),s=document.createElement("iframe"),r=n.querySelectorAll("#editorTypebar [data-target]"),a=n.querySelectorAll("#editorToolbar button"),i=n.querySelectorAll('[name="upload_files[]"]'),l=n.querySelector("#uploadFiles"),d=n.querySelectorAll("#uploadedFiles img"),c=e=>{this.isHtmlmode=o.classList.contains("d-none"),e&&!this.isHtmlmode?(s.style.height=o.offsetHeight+"px",s.contentWindow.document.body.innerHTML=o.value,o.classList.add("d-none"),s.classList.remove("d-none")):!e&&this.isHtmlmode&&(o.style.height=s.offsetHeight+"px",o.value=s.contentWindow.document.body.innerHTML,s.classList.add("d-none"),o.classList.remove("d-none")),this.isHtmlmode=o.classList.contains("d-none")},u=e=>{const t=s.contentWindow;return this.isHtmlmode?t.document.body.focus():o.focus(),this.isHtmlmode?t.getSelection?t.getSelection():t.document.getSelection?t.document.getSelection():void 0:{start:o.selectionStart,end:o.selectionEnd,value:o.value.slice(o.selectionStart,o.selectionEnd)}},m=e=>{const t=u();if(this.isHtmlmode){let n=t.getRangeAt(0);if(n){const o=s.contentWindow.document.createElement("div");o.appendChild(n.cloneContents()),o.innerHTML=e.replace(/%s/,o.innerHTML),n.deleteContents(),n.insertNode(o.firstElementChild),n.setStart(t.focusNode,t.focusOffset),n.setEnd(t.anchorNode,t.anchorOffset)}}else{e=e.replace(/%s/,t.value?t.value:"...");const n=o.value.slice(0,t.start),s=o.value.slice(-1*(o.value.length-t.end));o.value=n+e+s}};s.classList.add("form-control","resizable","p-0","d-none"),s.addEventListener("load",(e=>{const t=`<meta http-equiv="Pragma" content="no-cache">\n\t\t<meta http-equiv="Cache-Control" content="no-cache">\n\t\t<link rel="stylesheet" href="${request_uri}module/editor/editor.min.css">`;s.style.resize="vertical",s.contentWindow.document.head.innerHTML=t,s.contentWindow.document.designMode=this.readonly?"off":"on",s.contentWindow.document.body.innerHTML=o.value,s.contentWindow.document.body.addEventListener("drop",(e=>{e.preventDefault(),m(e.dataTransfer.getData("text")||"")}))})),o.parentNode.insertBefore(s,o),this.readonly&&(o.readOnly=!0);const h=e=>{const t=e.target.getAttribute("src").getQuery("file"),o=n.querySelector('[name="remove_files[]"][value="'+t+'"]');if(o)o.remove();else{const n=document.createElement("input");n.setAttribute("type","hidden"),n.setAttribute("name","remove_files[]"),n.setAttribute("value",t),e.target.parentNode.insertBefore(n,e.target)}},g=e=>{const t=e.target.getAttribute("src").getQuery("file");if(n.querySelector('[name="remove_files[]"][value="'+t+'"]'))return e.preventDefault(),!1;if(/<[img][^>]+[class]=[\\"\']+image\//g.test(e.target.outerHTML))e.dataTransfer.setData("text",e.target.outerHTML);else{const t=e.target.outerHTML.replace(/^(<[img]+\ssrc)([^>]+title=[\\"\']+)([^>\\"\']+)([^>]+)srcset=[\\"\']+[^>\\"\']+([^>]+>)$/g,'<a href$2$3$4target="_file$5$3</a>');e.dataTransfer.setData("text",t)}};d.forEach((e=>{e.addEventListener("click",h),e.addEventListener("dragstart",g)}));const f=e=>{for(window.trigger("beforeunload");l.firstChild;)l.removeChild(l.lastChild);const t=window.URL||window.webkitURL;Object.keys(e.target.files).map((n=>{let o=document.createElement("span"),s=e.target.files[n].name.escapeHtml(),r=e.target.files[n].size.shortSize(),a=e.target.files[n].type.escapeHtml(),i=t.createObjectURL(e.target.files[n]);window.uploadFiles.push(i);const d=window.uploadFiles.length-1;"image"!=a.slice(0,5)&&(a+='" srcset="./module/editor/bi-binary.svg');let c=`="${i}" title="${s} (${r})" alt="${s}" target="${d}"`;o.innerHTML='<image class="'+a+'" src'+c+">"+(1===e.target.files.length?"<span>"+e.target.value+"</span>":""),c="image"==a.slice(0,5)?"<image src"+c+">":`<a href${c}>${s} (${r})</a>`,o.addEventListener("dragstart",(e=>{e.dataTransfer.setData("text",c)})),l.append(o)}))};i.forEach((e=>e.addEventListener("change",f)));const v=e=>{e.preventDefault();const t={bold:"**%s**",italic:"*%s*",underline:"<u>%s</u>",strikethrough:"~~%s~~",insertorderedlist:"\n1. %s\n2. ",header:"<h2>%s</h2>",indent:"<blockquote>%s</blockquote>",codeblock:"<pre><code>%s</code></pre>",highlight:"<code>%s</code>"};let n=e.target.closest("button");switch(n=n.getAttribute("aria-label").toLowerCase(),n){case"bold":case"italic":case"underline":case"strikethrough":case"insertorderedlist":this.isHtmlmode?s.contentWindow.document.execCommand(n,!1,null):m(t[n]);break;case"highlight":m(this.isHtmlmode?t[n]:"`%s`");break;default:m(t[n]);break}this.isHtmlmode?s.contentWindow.document.body.focus():o.focus()},p=e=>{e.preventDefault();const t=e.target.getAttribute("data-target"),a=n.querySelector("[name="+t+"]"),i=e.target.getAttribute("data-value");"true"==i?(a.value=a.value==i?"false":"true","true"==a.value?e.target.classList.add("checked"):e.target.classList.remove("checked")):(r.forEach((e=>{"true"!=e.getAttribute("data-value")&&e.classList.remove("checked")})),a.value=i,e.target.classList.add("checked"),c("HTML"===e.target.innerText)),this.isHtmlmode?s.contentWindow.document.body.focus():o.focus()};a.forEach((e=>e.addEventListener("click",v))),r.forEach((e=>e.addEventListener("click",p))),r.forEach((e=>e.addEventListener("keydown",(e=>{32==e.which&&!0!==e.shiftKey&&(e.preventDefault(),e.target.click())})))),n.closest("FORM").addEventListener("submit",(e=>{try{if(this.isHtmlmode&&(o.value=s.contentWindow.document.body.innerHTML),this.required&&!o.value)throw this.isHtmlmode?s.contentWindow.document.body.focus():o.focus(),new Error(this.required)}catch(t){return e.stopPropagation(),e.preventDefault(),alert(t),!1}return!0})),this.html&&c(!0)}window.uploadFiles=[],window.addEventListener("beforeunload",(e=>{let t;const n=window.URL||window.webkitURL;for(;window.uploadFiles.length>0;)t=window.uploadFiles.pop(),n.revokeObjectURL(t)}));