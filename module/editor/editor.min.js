function afoxEditor(e,t){this.html=t.html,this.required=t.required,this.readonly=t.readonly,this.isHtmlmode=!1;const n=document.querySelector("#"+e),o=document.createElement("iframe"),s=n.querySelector("[name="+t.name+"]"),i=n.querySelectorAll("#editorTypebar [data-target]"),r=n.querySelectorAll("#editorToolbar button"),a=n.querySelectorAll('[name="upload_files[]"]'),l=n.querySelector("#uploadFiles"),d=n.querySelectorAll("#uploadedFiles img"),c=e=>{this.isHtmlmode=s.classList.contains("d-none"),e&&!this.isHtmlmode?(o.style.height=s.offsetHeight+"px",o.contentWindow.document.body.innerHTML=s.value,s.classList.add("d-none"),o.classList.remove("d-none")):!e&&this.isHtmlmode&&(s.style.height=o.offsetHeight+"px",s.value=o.contentWindow.document.body.innerHTML,o.classList.add("d-none"),s.classList.remove("d-none")),this.isHtmlmode=s.classList.contains("d-none")};this.querySelector=e=>(this.isHtmlmode||(o.contentWindow.document.body.innerHTML=s.value),o.contentWindow.document.body.querySelector(e)),this.querySelectorAll=e=>(this.isHtmlmode||(o.contentWindow.document.body.innerHTML=s.value),o.contentWindow.document.body.querySelectorAll(e)),this.getSelection=()=>{const e=o.contentWindow;return this.isHtmlmode?e.document.body.focus():s.focus(),this.isHtmlmode?e.getSelection?e.getSelection():e.document.getSelection?e.document.getSelection():void 0:{start:s.selectionStart,end:s.selectionEnd,value:s.value.slice(s.selectionStart,s.selectionEnd)}},this.pasteHtml=e=>{const t=this.getSelection();if(this.isHtmlmode){let n=t.getRangeAt(0);if(n){const s=o.contentWindow.document.createElement("div");s.appendChild(n.cloneContents()),s.innerHTML=e.replace(/%s/,s.innerHTML),n.deleteContents(),n.insertNode(s.firstElementChild),n.setStart(t.focusNode,t.focusOffset),n.setEnd(t.anchorNode,t.anchorOffset)}}else{e=e.replace(/%s/,t.value?t.value:"...");const n=s.value.slice(0,t.start),o=s.value.slice(-1*(s.value.length-t.end));s.value=n+e+o}},o.classList.add("form-control","resizable","p-0","d-none"),o.addEventListener("load",(e=>{const t=`<meta http-equiv="Pragma" content="no-cache">\n\t\t<meta http-equiv="Cache-Control" content="no-cache">\n\t\t<link rel="stylesheet" href="${request_uri}module/editor/editor.min.css">`;o.style.resize="vertical",o.contentWindow.document.head.innerHTML=t,o.contentWindow.document.designMode=this.readonly?"off":"on",o.contentWindow.document.body.innerHTML=s.value,o.contentWindow.document.body.addEventListener("drop",(e=>{e.preventDefault(),this.pasteHtml(e.dataTransfer.getData("text")||"")}))})),s.parentNode.insertBefore(o,s),this.readonly&&(s.readOnly=!0);const u=e=>{const t=e.target.getAttribute("src").getQuery("file"),o=n.querySelector('[name="remove_files[]"][value="'+t+'"]');if(o)o.remove();else{const n=document.createElement("input");n.setAttribute("type","hidden"),n.setAttribute("name","remove_files[]"),n.setAttribute("value",t),e.target.parentNode.insertBefore(n,e.target)}},m=e=>{const t=e.target.getAttribute("src").getQuery("file");if(n.querySelector('[name="remove_files[]"][value="'+t+'"]'))return e.preventDefault(),!1;if(/<[img][^>]+[class]=[\\"\']+image\//g.test(e.target.outerHTML))e.dataTransfer.setData("text",e.target.outerHTML);else{const t=e.target.outerHTML.replace(/^(<[img]+\ssrc)([^>]+title=[\\"\']+)([^>\\"\']+)([^>]+)srcset=[\\"\']+[^>\\"\']+([^>]+>)$/g,'<a href$2$3$4target="_file$5$3</a>');e.dataTransfer.setData("text",t)}};d.forEach((e=>{e.addEventListener("click",u),e.addEventListener("dragstart",m)}));const h=e=>{for(window.trigger("beforeunload");l.firstChild;)l.removeChild(l.lastChild);const t=window.URL||window.webkitURL;Object.keys(e.target.files).map((n=>{let o=document.createElement("span"),s=e.target.files[n].name.escapeHtml(),i=e.target.files[n].size.shortSize(),r=e.target.files[n].type.escapeHtml(),a=t.createObjectURL(e.target.files[n]);window.uploadFiles.push(a);const d=window.uploadFiles.length-1;"image"!=r.slice(0,5)&&(r+='" srcset="./module/editor/bi-binary.svg');let c=`="${a}" title="${s} (${i})" alt="${s}" target="${d}"`;o.innerHTML='<image class="'+r+'" src'+c+">"+(1===e.target.files.length?"<span>"+e.target.value+"</span>":""),c="image"==r.slice(0,5)?"<image src"+c+">":`<a href${c}>${s} (${i})</a>`,o.addEventListener("dragstart",(e=>{e.dataTransfer.setData("text",c)})),l.append(o)}))};a.forEach((e=>e.addEventListener("change",h)));const g=e=>{e.preventDefault();const t={bold:"**%s**",italic:"*%s*",underline:"<u>%s</u>",strikethrough:"~~%s~~",insertorderedlist:"\n1. %s\n2. ",header:"<h2>%s</h2>",indent:"<blockquote>%s</blockquote>",codeblock:"<pre><code>%s</code></pre>",highlight:"<code>%s</code>"};let n=e.target.closest("button");switch(n=n.getAttribute("aria-label").toLowerCase(),n){case"bold":case"italic":case"underline":case"strikethrough":case"insertorderedlist":this.isHtmlmode?o.contentWindow.document.execCommand(n,!1,null):this.pasteHtml(t[n]);break;case"highlight":this.pasteHtml(this.isHtmlmode?t[n]:"`%s`");break;case"components":break;default:this.pasteHtml(t[n]);break}this.isHtmlmode?o.contentWindow.document.body.focus():s.focus()},f=e=>{e.preventDefault();const t=e.target.getAttribute("data-target"),r=n.querySelector("[name="+t+"]"),a=e.target.getAttribute("data-value");"true"==a?(r.value=r.value==a?"false":"true","true"==r.value?e.target.classList.add("checked"):e.target.classList.remove("checked")):(i.forEach((e=>{"true"!=e.getAttribute("data-value")&&e.classList.remove("checked")})),r.value=a,e.target.classList.add("checked"),c("HTML"===e.target.innerText)),this.isHtmlmode?o.contentWindow.document.body.focus():s.focus()};r.forEach((e=>e.addEventListener("click",g))),i.forEach((e=>e.addEventListener("click",f))),i.forEach((e=>e.addEventListener("keydown",(e=>{32==e.which&&!0!==e.shiftKey&&(e.preventDefault(),e.target.click())})))),n.closest("FORM").addEventListener("submit",(e=>{try{if(this.isHtmlmode&&(s.value=o.contentWindow.document.body.innerHTML),this.required&&!s.value)throw this.isHtmlmode?o.contentWindow.document.body.focus():s.focus(),new Error(this.required)}catch(t){return e.stopPropagation(),e.preventDefault(),alert(t),!1}return!0})),this.html&&c(!0)}window.uploadFiles=[],window.addEventListener("beforeunload",(e=>{let t;const n=window.URL||window.webkitURL;for(;window.uploadFiles.length>0;)t=window.uploadFiles.pop(),n.revokeObjectURL(t)}));